<!DOCTYPE html>
<html lang="zh" translate="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>é¾å…´è®°á°äº‘åé¢ Â· ç‚¹å•ç³»ç»Ÿ (V2.9 æœæ±+åŠ å¥¶ Â· åˆ†ç±»/ç»“å•/ç»Ÿè®¡/æ‰“å°)</title>
<meta name="color-scheme" content="light">
<style>
:root{
  --bg:#740c10; --bg-grad:linear-gradient(180deg,#740c10 0%,#660a0e 40%,#54090c 100%);
  --ink:#ffeecf; --ink-strong:#fff8dd; --line:#f5d78a; --brand:#ffd86b; --brand-ink:#5a3b00;
  --mut:#f7e7bb; --shadow:0 16px 40px rgba(0,0,0,.40);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;background:var(--bg);background-image:var(--bg-grad);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans SC","PingFang SC",sans-serif}
.container{max-width:980px;margin:0 auto;padding:14px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
  border:1.5px solid var(--line);border-radius:18px;padding:14px}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0));
  backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid rgba(241,213,138,.35)}
.head{display:flex;align-items:center;gap:12px;padding:10px 14px}
header .logo{height:70px;width:auto;max-width:205px;border-radius:10px;display:block;box-shadow:0 8px 20px rgba(0,0,0,.4)}
.langs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.langs button{border:1.5px solid var(--line);background:var(--brand);color:var(--brand-ink);
  padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.langs button.active{background:transparent;color:var(--ink);box-shadow:0 0 0 2px rgba(241,213,138,.6) inset}
label{display:block;margin:8px 0 6px;font-weight:800;color:var(--ink-strong)}
input[type="text"],input[type="date"],select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid var(--line);
  background:rgba(0,0,0,.18);color:var(--ink);font-weight:900}
textarea{min-height:80px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:680px){.row{grid-template-columns:1fr}}
#tables-quick{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.table-chip{border:1.5px solid var(--line);border-radius:10px;padding:6px 10px;background:rgba(255,255,255,.06);
  color:var(--ink);cursor:pointer;min-width:44px;text-align:center;font-weight:900}
.table-chip.active{background:var(--brand);color:var(--brand-ink)}
.cat{margin:14px 0;border:1.5px dashed var(--line);border-radius:18px;overflow:hidden}
.cat-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(255,255,255,.06);cursor:pointer}
.cat-h h3{margin:0;font-size:18px;letter-spacing:.3px;color:var(--ink-strong)}
.cat-b{display:none;padding:12px 12px 16px;background:rgba(0,0,0,.08)}
.cat-b.open{display:block}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:680px){.grid{grid-template-columns:1fr}}
.item{background:rgba(255,255,255,.06);border:1.5px solid var(--line);border-radius:14px;padding:12px}
.item h4{margin:0 0 6px;font-size:16px;color:var(--ink-strong)}
.item .price{font-weight:900;color:var(--mut)}
.item .extra{font-size:12px;opacity:.9;margin-top:6px;display:flex;align-items:center;gap:6px}
.act{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.btn{border:2px solid var(--line);background:var(--brand);color:var(--brand-ink);
  padding:10px 14px;border-radius:12px;cursor:pointer;min-width:44px;text-align:center;font-weight:900}
.btn.ghost{background:transparent;color:var(--ink)} .btn.full{width:100%}
.qty{min-width:54px;text-align:center;font-weight:900;font-size:18px;color:#fff}
.cart{margin-top:16px}
.cart table{width:100%;border-collapse:collapse;border:1.5px solid var(--line);overflow:hidden;border-radius:14px}
.cart th,.cart td{padding:10px;border-bottom:1px dashed rgba(241,213,138,.55);text-align:left}
.cart tfoot td{font-weight:900}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
@media (max-width:680px){.actions{grid-template-columns:1fr}}
.kpis{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:680px){.kpis{grid-template-columns:1fr 1fr}}
.kpis .chip{background:rgba(0,0,0,.12);border:1.5px solid var(--line);border-radius:14px;padding:12px;text-align:center}
@media print{body{background:#fff;color:#000} header,.no-print,.a4-menu,#checkoutBtn{display:none !important} .ticket{display:block}}
.ticket{display:none}
.ticket h2{margin:0 0 8px}
.hr{height:1px;background:repeating-linear-gradient(to right,#000 0,#000 6px,transparent 6px,transparent 12px);opacity:.5;margin:8px 0}
@media screen{.a4-menu{display:none}}
.a4-menu{width:210mm;min-height:297mm;margin:0 auto;padding:18mm 16mm;background:#7a0e12;color:#f8e7b0;
  border:2mm solid #f1d58a;border-radius:12px;box-shadow:var(--shadow);font-family:"Noto Serif SC","Playfair Display",serif}
.a4-menu h1{margin:.2em 0 .4em 0;font-size:28px;letter-spacing:.8px;text-align:center}
.a4-row{display:grid;grid-template-columns:1fr 1fr;gap:8mm}
.a4-card{border:1.6px solid var(--line);border-radius:10px;padding:6mm;background:rgba(255,255,255,.05)}
.a4-title{font-weight:800;font-size:16px;margin:0 0 4mm 0}
.a4-li{display:flex;justify-content:space-between;margin:2mm 0}
.a4-li b{font-weight:800}
/* ç»“å•æŒ‰é’®ï¼šæ”¾å¤§åˆ° 1.5 å€å¹¶å›ºå®šå³ä¸‹ */
#checkoutBtn{
  position:fixed; right:14px; bottom:14px; z-index:9999;
  box-shadow:0 10px 26px rgba(0,0,0,.35);
  transform:scale(1.5); transform-origin:bottom right;
}
/* ç»Ÿè®¡é¢æ¿ */
#statsPanel .row{grid-template-columns:1fr 1fr}
/* è½»æç¤º */
.toast{position:fixed;left:50%;bottom:88px;transform:translateX(-50%);
  background:rgba(0,0,0,.7);color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;z-index:99999;display:none}
.toast.show{display:block}
</style>
</head>
<body>
<header class="shadow">
  <div class="head container">
    <img class="logo" src="logo.png" alt="LYX" onerror="this.style.display='none'">
    <div class="langs">
      <button data-lang="zh" class="active">ä¸­æ–‡</button>
      <button data-lang="en">English</button>
      <button data-lang="vi">Tiáº¿ng Viá»‡t</button>
    </div>
  </div>
</header>

<div class="container">
  <!-- åŸºæœ¬ä¿¡æ¯ -->
  <div class="card">
    <div class="row">
      <div>
        <label data-i="table_label">æ¡Œå·</label>
        <input id="tableNo" type="text" placeholder="01 / 02 / æ‰“åŒ…">
        <div id="tables-quick"><span class="table-chip" data-table="æ‰“åŒ…">æ‰“åŒ…</span></div>
      </div>
      <div>
        <label data-i="type_label">ç”¨é¤æ–¹å¼</label>
        <select id="type">
          <option value="dinein" data-i="dinein" selected>å ‚é£Ÿ</option>
          <option value="takeaway" data-i="takeaway">æ‰“åŒ…</option>
        </select>
      </div>
    </div>
  </div>

  <!-- åˆ†ç±»å®¹å™¨ -->
  <div id="cats"></div>

  <!-- è´­ç‰©è½¦ -->
  <div class="cart card">
    <h3 data-i="cart">è®¢å• / Cart</h3>
    <table id="cartTable">
      <thead>
        <tr>
          <th data-i="item">å“é¡¹</th>
          <th data-i="qty">æ•°é‡</th>
          <th data-i="price">é‡‘é¢</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="2" data-i="total">åˆè®¡ Total</td><td id="total">RM 0.00</td></tr>
      </tfoot>
    </table>

    <label style="margin-top:10px" data-i="note_label">å¤‡æ³¨</label>
    <textarea id="note" placeholder="ä¾‹å¦‚ï¼šå°‘ç”œ / å°‘å†° / åŠ è¾£" data-i-ph="note_ph"></textarea>

    <div class="actions no-print">
      <button class="btn full" id="statsBtn">ä»Šæ—¥æ˜ç»†ç»Ÿè®¡</button>
    </div>

    <div class="kpis no-print">
      <div class="chip"><div data-i="k1">è®¢å•ç¬”æ•°</div><div id="k_orders" style="font-weight:900;font-size:18px">0</div></div>
      <div class="chip"><div data-i="k2">å”®å‡ºä»¶æ•°</div><div id="k_items" style="font-weight:900;font-size:18px">0</div></div>
      <div class="chip"><div data-i="k3">é”€å”®é‡‘é¢</div><div id="k_amount" style="font-weight:900;font-size:18px">RM 0.00</div></div>
    </div>
  </div>

  <!-- ç»Ÿè®¡åŠŸèƒ½é¢æ¿ -->
  <div class="card no-print" id="statsPanel" style="display:none; margin-top:12px">
    <h3>ç»Ÿè®¡ Â· æŒ‰æ—¥æœŸ</h3>
    <div class="row">
      <div>
        <label>æ—¥æœŸ</label>
        <input type="date" id="statDate">
      </div>
      <div>
        <label>æ“ä½œ</label>
        <button class="btn full" id="calcBtn">ç»Ÿè®¡å¹¶å‘é€ WhatsApp</button>
      </div>
    </div>
    <div id="statResult" style="margin-top:10px"></div>
  </div>

  <!-- æ‰“å°å°ç¥¨ -->
  <div class="ticket">
    <h2 id="t_title">é¾å…´è®°á°äº‘åé¢ Â· å°ç¥¨</h2>
    <div id="t_shop"></div><div class="hr"></div>
    <div id="t_info"></div><div class="hr"></div>
    <div id="t_items"></div><div class="hr"></div>
    <div id="t_total"></div>
    <div>è°¢è°¢æƒ é¡¾ Â· Terima kasih</div>
  </div>

  <!-- ç»“å•æŒ‰é’®ï¼ˆ1.5xï¼‰ -->
  <button id="checkoutBtn" class="btn no-print">ç»“å•</button>
</div>

<div class="toast" id="toast">å·²æ·»åŠ å¤‡æ³¨ï¼šåŠ å¥¶</div>

<script>
/* ===== åŸºæœ¬é…ç½® / I18N ===== */
let LANG='zh';
const I18N={
  table_label:{zh:"æ¡Œå·",en:"Table",vi:"BÃ n"},
  type_label:{zh:"ç”¨é¤æ–¹å¼",en:"Service Type",vi:"HÃ¬nh thá»©c"},
  dinein:{zh:"å ‚é£Ÿ",en:"Dine-in",vi:"Ä‚n táº¡i chá»—"},
  takeaway:{zh:"æ‰“åŒ…",en:"Takeaway",vi:"Mang Ä‘i"},
  cart:{zh:"è®¢å• / Cart",en:"Cart",vi:"Giá» hÃ ng"},
  item:{zh:"å“é¡¹",en:"Item",vi:"MÃ³n"},
  qty:{zh:"æ•°é‡",en:"Qty",vi:"SL"},
  price:{zh:"é‡‘é¢",en:"Amount",vi:"Tiá»n"},
  total:{zh:"åˆè®¡ Total",en:"Total",vi:"Tá»•ng"},
  note_label:{zh:"å¤‡æ³¨",en:"Note",vi:"Ghi chÃº"},
  note_ph:{zh:"ä¾‹å¦‚ï¼šå°‘ç”œ / å°‘å†° / åŠ è¾£",en:"e.g. less sweet / less ice / spicy",vi:"vd: Ã­t ngá»t / Ã­t Ä‘Ã¡ / cay"},
  submit:{zh:"å‘é€åˆ° WhatsApp",en:"Send to WhatsApp",vi:"Gá»­i qua WhatsApp"},
  print:{zh:"æ‰“å°å°ç¥¨",en:"Print Ticket",vi:"In hoÃ¡ Ä‘Æ¡n"},
  export:{zh:"å¯¼å‡ºæœ¬å• CSV",en:"Export this order CSV",vi:"Xuáº¥t CSV (Ä‘Æ¡n nÃ y)"},
  k1:{zh:"è®¢å•ç¬”æ•°",en:"Orders",vi:"Sá»‘ Ä‘Æ¡n"},
  k2:{zh:"å”®å‡ºä»¶æ•°",en:"Items",vi:"Máº·t hÃ ng"},
  k3:{zh:"é”€å”®é‡‘é¢",en:"Sales",vi:"Doanh thu"},
  add:{zh:"+1",en:"+1",vi:"+1"}, minus:{zh:"-1",en:"-1",vi:"-1"},
  expand:{zh:"ç‚¹å‡»å±•å¼€/æ”¶èµ·",en:"Expand/Collapse",vi:"Má»Ÿ/ÄÃ³ng"},
  cat_wonton:{zh:"ğŸœ äº‘åé¢",en:"Wonton Noodles",vi:"MÃ¬ hoÃ nh thÃ¡nh"},
  cat_drinks:{zh:"ğŸ¥¤ é¥®æ–™ï¼ˆå†°é¥® +RM0.20ï¼Œç½è£…æ°´é™¤å¤–ï¼‰",en:"Drinks",vi:"Äá»“ uá»‘ng"},
  cat_roti:{zh:"ğŸ Roti",en:"Roti",vi:"Roti"},
  cat_auntie:{zh:"ğŸ² å©¶å©¶æ¡£ï¼ˆå®¶å¸¸å°ç‚’ Â· ç²¥ç²‰é¢é¥­ï¼‰",en:"Auntie Stall",vi:"Quáº§y CÃ´"},
  cat_gx:{zh:"ğŸ¥Ÿ å¹¿è¥¿å·ç­’ç²‰ï¼ˆå¤æ—©é£å‘³ï¼‰",en:"Guangxi Rice Rolls",vi:"BÃ¡nh cuá»‘n Quáº£ng TÃ¢y"},
  cat_juice:{zh:"ğŸ¹ æœæ±",en:"Juice",vi:"NÆ°á»›c Ã©p"}
};
function t(k){return (I18N[k]&&I18N[k][LANG])||k}
function applyI18N(){
  document.querySelectorAll('[data-i]').forEach(el=>el.textContent=t(el.getAttribute('data-i')));
  document.querySelectorAll('[data-i-ph]').forEach(el=>el.placeholder=t(el.getAttribute('data-i-ph')));
}

/* ===== å®Œæ•´èœå•ï¼ˆå·²æŒ‰ä½ çš„è¦æ±‚æ›´æ–°ï¼‰ ===== */
const MENU=[
  { key:'cat_wonton', sections:[{title:'', items:[
    {name:'äº‘åé¢ï¼ˆå°ï¼‰', price:6.50},
    {name:'äº‘åé¢ï¼ˆä¸­ï¼‰', price:7.30},
    {name:'äº‘åé¢ï¼ˆå¤§ï¼‰', price:8.00},
    {name:'äº‘å å¹²æï¼ˆ1 setï¼‰', price:5.00},
    {name:'äº‘å æ±¤ï¼ˆ1 setï¼‰', price:5.00},
    {name:'åŠ æ–™ï¼šäº‘å Ã—3', price:1.00},
  ]}]},
  { key:'cat_drinks', sections:[{title:'', items:[
    {name:'å’–å•¡ï¼ˆçƒ­ï¼‰', price:2.30},
    {name:'å’–å•¡ï¼ˆå†°ï¼‰', price:2.50},
    {name:'å’–å•¡Cï¼ˆçƒ­ï¼‰', price:2.60},
    {name:'å’–å•¡Cï¼ˆå†°ï¼‰', price:2.80},
    {name:'å’–å•¡Oï¼ˆçƒ­ï¼‰', price:2.00},
    {name:'å’–å•¡Oï¼ˆå†°ï¼‰', price:2.20},
    {name:'å¥¶èŒ¶ï¼ˆçƒ­ï¼‰', price:2.30},
    {name:'å¥¶èŒ¶ï¼ˆå†°ï¼‰', price:2.50},
    {name:'å¥¶èŒ¶Cï¼ˆçƒ­ï¼‰', price:2.60},  // æ”¹ä»·
    {name:'å¥¶èŒ¶Cï¼ˆå†°ï¼‰', price:2.80},  // æ”¹ä»·
    {name:'å¥¶èŒ¶å’¸Cï¼ˆçƒ­ï¼‰', price:2.60},
    {name:'å¥¶èŒ¶å’¸Cï¼ˆå†°ï¼‰', price:2.80},
    {name:'å¥¶èŒ¶Oï¼ˆçƒ­ï¼‰', price:2.00},
    {name:'å¥¶èŒ¶Oï¼ˆå†°ï¼‰', price:2.20},
    {name:'Nescafeï¼ˆçƒ­ï¼‰', price:2.80},
    {name:'Nescafeï¼ˆå†°ï¼‰', price:3.00},
    {name:'Miloï¼ˆçƒ­ï¼‰', price:2.60},
    {name:'Miloï¼ˆå†°ï¼‰', price:2.80},
    {name:'Milo Cï¼ˆçƒ­ï¼‰', price:2.80},
    {name:'Milo Cï¼ˆå†°ï¼‰', price:3.00},
    {name:'Milo Oï¼ˆçƒ­ï¼‰', price:2.60},
    {name:'Milo Oï¼ˆå†°ï¼‰', price:2.80},
    {name:'Nesloï¼ˆçƒ­ï¼‰', price:2.80},     // æ–°å¢
    {name:'Nesloï¼ˆå†°ï¼‰', price:3.00},     // æ–°å¢
    {name:'é¸³é¸¯ï¼ˆçƒ­ï¼‰', price:2.80},       // æ–°å¢
    {name:'é¸³é¸¯ï¼ˆå†°ï¼‰', price:3.00},       // æ–°å¢
    {name:'Nestleï¼ˆçƒ­ï¼‰', price:2.80},     // æ–°å¢
    {name:'é’“é±¼ â€œèŒ¶åŒ…â€', price:1.00},     // æ–°å¢\
    {name:'å‡‰èŒ¶ï¼ˆçƒ­ï¼‰', price:1.50},
    {name:'å‡‰èŒ¶ï¼ˆå†°ï¼‰', price:1.70},
    {name:'ç‰ç±³ï¼ˆçƒ­ï¼‰', price:1.50},
    {name:'ç‰ç±³ï¼ˆå†°ï¼‰', price:1.70},
    
    {name:'ç½è£…æ°´', price:2.50},
  ]}]},
  { key:'cat_roti', sections:[{title:'', items:[
    {name:'Roti', price:2.00},
    {name:'Roti Butter', price:2.50},
    {name:'ç”Ÿç†Ÿè›‹ â€œSetâ€', price:2.40}    // æ–°å¢
  ]}]},
  { key:'cat_juice', sections:[{title:'', items:[          // æ–°åˆ†ç±»ï¼šæœæ±ï¼ˆç»Ÿä¸€ RM5ï¼‰
    {name:'è‹¹æœæ±', price:5.00},
    {name:'æ©™æ±', price:5.00},
    {name:'èåœæ±', price:5.00},
    {name:'è¥¿ç“œæ±', price:5.00},
    {name:'èœœç“œæ±', price:5.00},
  ]}]},
  { key:'cat_auntie', sections:[{title:'', items:[
    {name:'è‹¦ç“œç±³ç²‰', price:6.00},
    {name:'Nasi Lemakï¼ˆè›‹ï¼‰', price:3.00},
    {name:'Nasi Lemakï¼ˆé¸¡ï¼‰', price:6.00},
    {name:'é¢ç²‰ç³•', price:6.00},
    {name:'çº¢çƒ§é¥­', price:6.00},
    {name:'é±¼ç²¥ï¼ˆçŒªè‚‰ï¼‰', price:6.00},
    {name:'é±¼ç²¥ï¼ˆé¸¡è‚‰ï¼‰', price:6.00},
    {name:'é¢çº¿', price:6.00},
    {name:'å¤è‚‰é¥­', price:6.00},
    {name:'æœæ¡æ±¤', price:6.00},
    {name:'åŠ çš®è›‹', price:1.00},
    {name:'é…¸ç¬‹ç“œ', price:1.50},
    {name:'é…¸ç¾Šè§’è±†', price:1.50},
    {name:'é…¸è‹¦ç“œ', price:1.50},
    {name:'é…¸è±†è…', price:1.50},
    {name:'ç‚¸é¸¡ç¿…è†€', price:3.00},
    {name:'ç…é¸¡è›‹', price:1.00},
  ]}]},
  { key:'cat_gx', sections:[{title:'', items:[
    {name:'ç´ ç²‰ (kosong)', price:1.00},
    {name:'è”¬èœå·ç­’ç²‰', price:2.00},
    {name:'èœåŠ è‚‰å·ç­’ç²‰', price:3.00},
    {name:'è‚‰å·ç­’ç²‰', price:3.00},
    {name:'å…¨å®¶ç¦å·ç­’ç²‰', price:4.00},
    {name:'æ˜¥å·', price:1.00},
    {name:'èŠ‹å¤´ç±³ç³•', price:1.00},
  ]}]},
];


/* ===== æ„å»ºèœå•ï¼ˆé¥®æ–™åˆå¹¶å†·çƒ­ï¼›æœæ±â€œåŠ å¥¶â€ï¼‰ ===== */
const catsEl=document.getElementById('cats');
const NAME_TO_CAT=new Map();


/* ===== helper: group drinks into base with hot/ice ===== */
function groupDrinks(items){
  const groups = {}; // base -> {hot:{price}, ice:{price}}
  items.forEach(it=>{
    let m = it.name.match(/^(.*)ï¼ˆ(çƒ­|å†°)ï¼‰$/);
    if(!m){ return; }
    const base=m[1]; const kind=m[2]; // çƒ­ or å†°
    groups[base] = groups[base] || {hot:null, ice:null};
    if(kind==='çƒ­'){ groups[base].hot = {price:it.price}; }
    if(kind==='å†°'){ groups[base].ice = {price:it.price}; }
  });
  return groups;
}

MENU.forEach((cat)=>{
  const wrap=document.createElement('div'); wrap.className='cat card';
  wrap.innerHTML=`<div class="cat-h" data-toggle><h3>${t(cat.key)}</h3><div style="opacity:.8">${t('expand')}</div></div><div class="cat-b"><div class="grid"></div></div>`;
  const grid=wrap.querySelector('.grid');

  // Special rendering for drinks: compress hot/ice into one card with two checkboxes
  if(cat.key==='cat_drinks'){
    const all = cat.sections.flatMap(s=>s.items);
    const groups = groupDrinks(all);
    // Render only grouped bases first
    Object.keys(groups).forEach(base=>{
      const hot = groups[base].hot, ice = groups[base].ice;
      const hotId = `${base}ï¼ˆçƒ­ï¼‰__${hot?hot.price:''}`;
      const iceId = `${base}ï¼ˆå†°ï¼‰__${ice?ice.price:''}`;
      NAME_TO_CAT.set(`${base}ï¼ˆçƒ­ï¼‰`,'cat_drinks');
      NAME_TO_CAT.set(`${base}ï¼ˆå†°ï¼‰`,'cat_drinks');
      grid.insertAdjacentHTML('beforeend', `
        <div class="item">
          <h4>${base}</h4>
          <div class="extra" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <label><input type="checkbox" data-drinkchk="${hotId}"> çƒ­</label>
              <div class="price">RM ${hot?Number(hot.price).toFixed(2):'â€”'}</div>
              <div class="act">
                <button class="btn ghost" data-sub="${hotId}">${t('minus')}</button>
                <div class="qty" data-qty="${hotId}">0</div>
                <button class="btn" data-add="${hotId}">${t('add')}</button>
              </div>
            </div>
            <div>
              <label><input type="checkbox" data-drinkchk="${iceId}"> å†°</label>
              <div class="price">RM ${ice?Number(ice.price).toFixed(2):'â€”'}</div>
              <div class="act">
                <button class="btn ghost" data-sub="${iceId}">${t('minus')}</button>
                <div class="qty" data-qty="${iceId}">0</div>
                <button class="btn" data-add="${iceId}">${t('add')}</button>
              </div>
            </div>
          </div>
        </div>
      `);
    });
    // Render remaining non-hot/ice drinks (e.g., ç½è£…æ°´ã€é’“é±¼â€œèŒ¶åŒ…â€)
    all.forEach(it=>{
      if(/ï¼ˆçƒ­ï¼‰|ï¼ˆå†°ï¼‰/.test(it.name)) return;
      NAME_TO_CAT.set(it.name,'cat_drinks');
      const id = `${it.name}__${it.price}`;
      grid.insertAdjacentHTML('beforeend', `
        <div class="item">
          <h4>${it.name}</h4>
          <div class="price">RM ${Number(it.price).toFixed(2)}</div>
          <div class="act">
            <button class="btn ghost" data-sub='${id}'>${t('minus')}</button>
            <div class="qty" data-qty='${id}'>0</div>
            <button class="btn" data-add='${id}'>${t('add')}</button>
          </div>
        </div>`);
    });
  } else {
    // Default rendering for other categories
    cat.sections.forEach(sec=>{
      sec.items.forEach(it=>{
        NAME_TO_CAT.set(it.name,cat.key);
        const id = `${it.name}__${it.price}`;
        const isJuice = (cat.key==='cat_juice');
        grid.insertAdjacentHTML('beforeend', `
        <div class="item">
          <h4>${it.name}</h4>
          <div class="price">RM ${Number(it.price).toFixed(2)}</div>
          ${isJuice ? `<div class="extra"><label><input type="checkbox" data-milk="${id}"> åŠ å¥¶</label></div>`:''}
          <div class="act">
            <button class="btn ghost" data-sub='${id}'>${t('minus')}</button>
            <div class="qty" data-qty='${id}'>0</div>
            <button class="btn" data-add='${id}'>${t('add')}</button>
          </div>
        </div>`);
      });
    });
  }

  catsEl.appendChild(wrap);
});
catsEl.addEventListener('click',e=>{
  const h=e.target.closest('[data-toggle]'); if(h){ const b=h.parentElement.querySelector('.cat-b'); b.classList.toggle('open'); }
});
document.addEventListener('DOMContentLoaded', ()=> {
  document.querySelectorAll('.cat-b').forEach(b=> b.classList.remove('open'));
});

/* ===== è´­ç‰©è½¦ / KPI ===== */

let CART=[];
function ensureNoteMilk(itemName){
  const note=document.getElementById('note');
  const tag = `${itemName} åŠ å¥¶`;
  if(!note.value.includes(tag)){
    note.value = (note.value? note.value + ' Â· ' : '') + tag;
    showToast('å·²æ·»åŠ å¤‡æ³¨ï¼šåŠ å¥¶');
  }
}
function addToCart(name,price,delta=1,isMilk=false){
  const p=Number(price);
  const displayName = isMilk ? `${name}ï¼ˆåŠ å¥¶ï¼‰` : name;
  let found=CART.find(x=>x.name===displayName&&x.price===p);
  if(found){ found.qty+=delta; if(found.qty<=0) CART=CART.filter(x=>x!==found); }
  else if(delta>0){ CART.push({name:displayName,price:p,qty:1,cat:NAME_TO_CAT.get(name)||'unknown'}); }
  renderCart(); syncAllQty();
}
function syncAllQty(){
  document.querySelectorAll('.qty[data-qty]').forEach(q=> q.textContent='0');
  CART.forEach(it=>{
    const key = `${it.name.replace('ï¼ˆåŠ å¥¶ï¼‰','')}__${it.price}`;
    const el=document.querySelector(`.qty[data-qty='${key}']`);
    if(el) el.textContent=it.qty;
  });
}
catsEl.addEventListener('click',e=>{
  const ad=e.target.getAttribute('data-add'); const sb=e.target.getAttribute('data-sub');
  if(ad){
    const [n,p]=ad.split('__');
    const cat=NAME_TO_CAT.get(n)||'unknown';
    let milk=false;
    if(cat==='cat_juice'){
      const chk=document.querySelector(`[data-milk='${n}__${p}']`);
      milk = !!(chk && chk.checked);
      if(milk){ ensureNoteMilk(n); }
    }
    addToCart(n,p,1,milk);
  }
  if(sb){
    const [n,p]=sb.split('__');
    addToCart(n,p,-1,false);
  }
});
function renderCart(){
  const tb=document.querySelector('#cartTable tbody'); tb.innerHTML='';
  let total=0, items=0;
  CART.forEach((it)=>{
    total+=it.qty*it.price; items+=it.qty;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.name}</td><td>${it.qty}</td><td>RM ${(it.qty*it.price).toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('total').textContent='RM '+total.toFixed(2);
  document.getElementById('k_items').textContent=items;
  document.getElementById('k_amount').textContent='RM '+total.toFixed(2);
}

/* å¯¼å‡º CSVï¼ˆå½“å‰è®¢å•ï¼‰ */
function exportCSV(){
  const rows=[["Item","Qty","Unit Price","Amount"]];
  let total=0; CART.forEach(it=>{const amt=it.qty*it.price; total+=amt; rows.push([it.name,it.qty,it.price,amt]);});
  rows.push(["Total","","",total.toFixed(2)]);
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='order.csv'; a.click();
}

/* æ‰“å°å°ç¥¨ï¼ˆæ¢è¡Œï¼‰ */
function printTicket(){
  const tShop=document.getElementById('t_shop');
  const tInfo=document.getElementById('t_info');
  const tItems=document.getElementById('t_items');
  const tTotal=document.getElementById('t_total');
  const table=(document.getElementById('tableNo').value||'').trim();
  const type=document.getElementById('type').value;
  const sum=CART.reduce((s,it)=>s+it.qty*it.price,0);
  document.getElementById('t_title').textContent='é¾å…´è®°á°äº‘åé¢ Â· å°ç¥¨';
  const logo=''; // å¯æ›¿æ¢ LOGO
  tShop.innerHTML=`${logo}<b>é¾è¿è½©á°ç¾é£Ÿä¸­å¿ƒ</b>`;
  tInfo.textContent=`æ¡Œå·: ${table||'-'} Â· ${type==='dinein'?'å ‚é£Ÿ':'æ‰“åŒ…'}`;
  tItems.innerHTML=CART.map(it=>`${it.name} Ã—${it.qty} â€” RM ${(it.qty*it.price).toFixed(2)}`).join('<br>');
  tTotal.textContent='åˆè®¡: RM '+sum.toFixed(2);
  window.print();
}

/* KPI ç´¯è®¡ï¼ˆç®€æ˜“æ€»è®¡ï¼‰ */
const KEY_ORDERS='LYX_ACCUM_ORDERS_SIMPLE';
const KEY_AMOUNT='LYX_ACCUM_AMOUNT_SIMPLE';
const KEY_ITEMS='LYX_ACCUM_ITEMS_SIMPLE';
function bumpKPI(sum){
  const orders=Number(localStorage.getItem(KEY_ORDERS)||0)+1;
  const amount=Number(localStorage.getItem(KEY_AMOUNT)||0)+Number(sum||0);
  const items = CART.reduce((s,it)=>s+it.qty,0) + Number(localStorage.getItem(KEY_ITEMS)||0);
  localStorage.setItem(KEY_ORDERS, String(orders));
  localStorage.setItem(KEY_AMOUNT, String(amount));
  localStorage.setItem(KEY_ITEMS, String(items));
  document.getElementById('k_orders').textContent=orders;
  document.getElementById('k_amount').textContent='RM '+amount.toFixed(2);
  document.getElementById('k_items').textContent=items;
}
function initKPI(){
  const orders=Number(localStorage.getItem(KEY_ORDERS)||0);
  const amount=Number(localStorage.getItem(KEY_AMOUNT)||0);
  const items=Number(localStorage.getItem(KEY_ITEMS)||0);
  document.getElementById('k_orders').textContent=orders;
  document.getElementById('k_amount').textContent='RM '+amount.toFixed(2);
  document.getElementById('k_items').textContent=items;
}

/* ======= è®¢å•å†å² & æ—¥æœŸç»Ÿè®¡ ======= */
const KEY_ORDERS_JSON = 'LYX_ORDERS_V1';
function loadOrders(){ try{ return JSON.parse(localStorage.getItem(KEY_ORDERS_JSON)||'[]'); } catch{ return []; } }
function saveOrders(list){ localStorage.setItem(KEY_ORDERS_JSON, JSON.stringify(list)); }
function pushOrderToHistory(payload){ const list = loadOrders(); list.push(payload); saveOrders(list); }

function calcStatsByDate(yyyy_mm_dd){
  const list = loadOrders();
  if(!yyyy_mm_dd) return {orders:0, amount:0, cat:{}};
  const [Y,M,D] = yyyy_mm_dd.split('-').map(Number);
  const start = new Date(Y, M-1, D, 0,0,0,0).getTime();
  const end   = new Date(Y, M-1, D, 23,59,59,999).getTime();
  const dayOrders = list.filter(o => o.ts>=start && o.ts<=end);
  let sum = 0;
  const catMap = new Map();
  dayOrders.forEach(o=>{
    sum += o.total;
    o.items.forEach(it=>{
      const cat = it.cat || 'unknown';
      const m = catMap.get(cat) || {amount:0, orders:0, items:0};
      m.amount += it.price * it.qty;
      m.items  += it.qty;
      catMap.set(cat, m);
    });
  });
  dayOrders.forEach(o=>{
    const seen = new Set();
    o.items.forEach(it=> seen.add(it.cat||'unknown'));
    seen.forEach(cat=>{
      const m = catMap.get(cat) || {amount:0, orders:0, items:0};
      m.orders += 1;
      catMap.set(cat, m);
    });
  });
  const cat = [...catMap.entries()]
    .sort((a,b)=>b[1].amount - a[1].amount)
    .reduce((o,[k,v])=>{ o[k]=v; return o; }, {});
  return {orders: dayOrders.length, amount: Number(sum.toFixed(2)), cat};
}
function renderStatsAndBuildWA(dateStr, stat){
  const lines = [];
  lines.push(`ã€é¾è¿è½©á°ç¾é£Ÿä¸­å¿ƒã€‘é”€å”®ç»Ÿè®¡`);
  lines.push(`æ—¥æœŸ: ${dateStr}`);
  lines.push(`æ€»è®¡: ${stat.orders} å• Â· RM ${stat.amount.toFixed(2)}`);
  lines.push('â€”â€” åˆ†ç±»ç»Ÿè®¡ â€”â€”');
  const humanCatName = (key)=>({
    cat_wonton:'ğŸœ äº‘åé¢',
    cat_drinks:'ğŸ¥¤ é¥®æ–™',
    cat_roti:'ğŸ Roti',
    cat_auntie:'ğŸ² å©¶å©¶æ¡£',
    cat_gx:'ğŸ¥Ÿ å¹¿è¥¿å·ç­’ç²‰',
    cat_juice:'ğŸ¹ æœæ±',
    unknown:'å…¶ä»–'
  }[key] || key);
  const out = [];
  Object.keys(stat.cat).forEach(k=>{
    const v = stat.cat[k];
    out.push(`${humanCatName(k)} Â· ${v.orders} å• Â· ä»¶æ•° ${v.items} Â· RM ${v.amount.toFixed(2)}`);
  });
  const html = [`<div>ã€é¾è¿è½©á°ç¾é£Ÿä¸­å¿ƒã€‘é”€å”®ç»Ÿè®¡</div>`,
                `<div>æ—¥æœŸ: ${dateStr}</div>`,
                `<div>æ€»è®¡: ${stat.orders} å• Â· RM ${stat.amount.toFixed(2)}</div>`,
                `<div>â€”â€” åˆ†ç±»ç»Ÿè®¡ â€”â€”</div>`,
                ...out.map(s=>`<div>${s}</div>`)];
  document.getElementById('statResult').innerHTML = html.join('');
  const wa = [`ã€é¾è¿è½©á°ç¾é£Ÿä¸­å¿ƒã€‘é”€å”®ç»Ÿè®¡`,
              `æ—¥æœŸ: ${dateStr}`,
              `æ€»è®¡: ${stat.orders} å• Â· RM ${stat.amount.toFixed(2)}`,
              `â€”â€” åˆ†ç±»ç»Ÿè®¡ â€”â€”`,
              ...out,
              '############',
              'ä»¥ä¸Šä¸ºè‡ªåŠ¨ç»Ÿè®¡ï¼Œä¾›å†…éƒ¨å‚è€ƒ'].join('\n');
  return wa;
}

/* ===== WhatsApp å‘é€ï¼ˆåŒçª—å£è·³è½¬ï¼Œé¿å…è¢«æ‹¦æˆªï¼‰ ===== */
function openWA(text){ location.href = 'https://wa.me/?text='+encodeURIComponent(text); }
function buildOrderText(){
  const table=(document.getElementById('tableNo').value||'').trim()||'-';
  const type=document.getElementById('type').value==='dinein'?'å ‚é£Ÿ':'æ‰“åŒ…';
  const note=(document.getElementById('note').value||'').trim();
  const sum=CART.reduce((s,it)=>s+it.qty*it.price,0);
  const orders=Number(localStorage.getItem(KEY_ORDERS)||0);
  const amount=Number(localStorage.getItem(KEY_AMOUNT)||0);
  const lines=[
    `ã€é¾è¿è½©á°ç¾é£Ÿä¸­å¿ƒã€‘ä¸‹å•`,
    `æ¡Œå·: ${table} Â· ${type}`,
    `â€”â€” æ˜ç»† â€”â€”`,
    ...CART.map(it=>`${it.name} Ã—${it.qty}  RM ${(it.qty*it.price).toFixed(2)}`),
    `åˆè®¡: RM ${sum.toFixed(2)}${note?` Â· å¤‡æ³¨: ${note}`:''}`,
    '############','############','############',
    `æ€»è®¡é”€å”®: ${orders} å• Â· RM ${amount.toFixed(2)}`,
    `å·²ç»åˆ†ç±»é”€å”®æ€»å•å’Œé”€å”®RM`,
    '############'
  ];
  return lines.join('\n');
}
function submitOrderToWhatsApp(){
  if(!CART.length){ alert('è¯·å…ˆåŠ å…¥å•†å“'); return; }
  const sum=CART.reduce((s,it)=>s+it.qty*it.price,0);
  bumpKPI(sum);
  const orderObj = {
    ts: Date.now(),
    table: (document.getElementById('tableNo').value||'').trim() || '-',
    type: (document.getElementById('type').value==='dinein'?'å ‚é£Ÿ':'æ‰“åŒ…'),
    note: (document.getElementById('note').value||'').trim(),
    total: Number(sum.toFixed(2)),
    items: CART.map(it=>({name:it.name, price:it.price, qty:it.qty, cat:(NAME_TO_CAT.get(it.name.replace('ï¼ˆåŠ å¥¶ï¼‰',''))||'unknown')}))
  };
  pushOrderToHistory(orderObj);
  if(navigator.vibrate){ navigator.vibrate(30); }
  const text=buildOrderText();
  openWA(text);
  CART=[]; renderCart(); document.getElementById('note').value=''; syncAllQty();
}

/* è½»æç¤º */
function showToast(msg){
  const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 1200);
}

/* å¿«æ·ï¼šæ¡Œå·â€œæ‰“åŒ…â€ */
(function makeTableChips(){
  const wrap=document.getElementById('tables-quick');
  wrap.addEventListener('click',e=>{
    const v=e.target.getAttribute('data-table'); if(!v) return;
    document.querySelectorAll('.table-chip').forEach(c=>c.classList.remove('active'));
    e.target.classList.add('active'); document.getElementById('tableNo').value=v;
  });
})();

/* è¯­è¨€åˆ‡æ¢ & æŒ‰é’®ç»‘å®š */
document.querySelectorAll('.langs button').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('.langs button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); LANG=b.getAttribute('data-lang');
    document.querySelectorAll('#cats .cat').forEach((wrap,i)=>{ wrap.querySelector('.cat-h h3').textContent=t(MENU[i].key); });
    document.querySelectorAll('.cat-h div:last-child').forEach(el=>el.textContent=t('expand'));
    applyI18N();
  };
});
applyI18N();
document.getElementById('checkoutBtn').onclick=submitOrderToWhatsApp;
document.getElementById('statsBtn').onclick = ()=> {
  const p = document.getElementById('statsPanel');
  p.style.display = (p.style.display==='none'||!p.style.display) ? 'block' : 'none';
};
document.getElementById('calcBtn').onclick = ()=>{
  const d = document.getElementById('statDate').value;
  if(!d){ alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }
  const stat = calcStatsByDate(d);
  const text = renderStatsAndBuildWA(d, stat);
  openWA(text);
};

/* å¯åŠ¨ */
renderCart();
syncAllQty();
initKPI();
</script>
</body>
</html>
