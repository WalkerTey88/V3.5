<!DOCTYPE html>
<html lang="zh" translate="no">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>龍兴记ᝰ云吞面 · 点单系统 (V2.15e 果汁+加奶 · 分类/结单/统计/打印)</title>
    <meta name="color-scheme" content="light">
    <style>
        :root {
            --bg: #740c10;
            --bg-grad: linear-gradient(180deg, #740c10 0%, #660a0e 40%, #54090c 100%);
            --ink: #ffeecf;
            --ink-strong: #fff8dd;
            --line: #f5d78a;
            --brand: #ffd86b;
            --brand-ink: #5a3b00;
            --mut: #f7e7bb;
            --shadow: 0 16px 40px rgba(0, 0, 0, .40);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            background: var(--bg);
            background-image: var(--bg-grad);
            color: var(--ink);
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Noto Sans SC", "PingFang SC", sans-serif;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 14px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
            border: 1.5px solid var(--line);
            border-radius: 18px;
            padding: 14px;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(0, 0, 0, .35), rgba(0, 0, 0, 0));
            backdrop-filter: saturate(120%) blur(6px);
            border-bottom: 1px solid rgba(241, 213, 138, .35);
        }

        .head {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
        }

        header .logo {
            height: 70px;
            width: auto;
            max-width: 205px;
            border-radius: 10px;
            display: block;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .4);
        }

        .langs {
            margin-left: auto;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .langs button {
            border: 1.5px solid var(--line);
            background: var(--brand);
            color: var(--brand-ink);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .25);
        }

        .langs button.active {
            background: transparent;
            color: var(--ink);
            box-shadow: 0 0 0 2px rgba(241, 213, 138, .6) inset;
        }

        label {
            display: block;
            margin: 8px 0 6px;
            font-weight: 800;
            color: var(--ink-strong);
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1.5px solid var(--line);
            background: rgba(0, 0, 0, .18);
            color: var(--ink);
            font-weight: 900;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 680px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        #tables-quick {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .table-chip {
            border: 1.5px solid var(--line);
            border-radius: 10px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, .06);
            color: var(--ink);
            cursor: pointer;
            min-width: 44px;
            text-align: center;
            font-weight: 900;
        }

        .table-chip.active {
            background: var(--brand);
            color: var(--brand-ink);
        }

        .cat {
            margin: 14px 0;
            border: 1.5px dashed var(--line);
            border-radius: 18px;
            overflow: hidden;
        }

        .cat-h {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: rgba(255, 255, 255, .06);
            cursor: pointer;
        }

        .cat-h h3 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .3px;
            color: var(--ink-strong);
        }

        .cat-b {
            display: none;
            padding: 12px 12px 16px;
            background: rgba(0, 0, 0, .08);
        }

        .cat-b.open {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        @media (max-width: 680px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .item {
            background: rgba(255, 255, 255, .06);
            border: 1.5px solid var(--line);
            border-radius: 14px;
            padding: 12px;
        }

        .item h4 {
            margin: 0 0 6px;
            font-size: 16px;
            color: var(--ink-strong);
        }

        .item .price {
            font-weight: 900;
            color: var(--mut);
        }

        .item .extra {
            font-size: 12px;
            opacity: .9;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .act {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .btn {
            border: 2px solid var(--line);
            background: var(--brand);
            color: var(--brand-ink);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            min-width: 44px;
            text-align: center;
            font-weight: 900;
        }

        .btn.ghost {
            background: transparent;
            color: var(--ink);
        }

        .btn.full {
            width: 100%;
        }

        .qty {
            min-width: 54px;
            text-align: center;
            font-weight: 900;
            font-size: 18px;
            color: #fff;
        }

        .cart {
            margin-top: 16px;
        }

        .cart table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid var(--line);
            overflow: hidden;
            border-radius: 14px;
        }

        .cart th,
        .cart td {
            padding: 10px;
            border-bottom: 1px dashed rgba(241, 213, 138, .55);
            text-align: left;
        }

        .cart tfoot td {
            font-weight: 900;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 680px) {
            .actions {
                grid-template-columns: 1fr;
            }
        }

        .kpis {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        @media (max-width: 680px) {
            .kpis {
                grid-template-columns: 1fr 1fr;
            }
        }

        .kpis .chip {
            background: rgba(0, 0, 0, .12);
            border: 1.5px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            text-align: center;
        }

        @media print {
            body {
                background: #fff;
                color: #000;
            }

            header,
            .no-print,
            .a4-menu,
            #checkoutBtn {
                display: none !important;
            }

            .ticket {
                display: block;
            }
        }

        .ticket {
            display: none;
        }

        .ticket h2 {
            margin: 0 0 8px;
        }

        .hr {
            height: 1px;
            background: repeating-linear-gradient(to right, #000 0, #000 6px, transparent 6px, transparent 12px);
            opacity: .5;
            margin: 8px 0;
        }

        @media screen {
            .a4-menu {
                display: none;
            }
        }

        .a4-menu {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 18mm 16mm;
            background: #7a0e12;
            color: #f8e7b0;
            border: 2mm solid #f1d58a;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-family: "Noto Serif SC", "Playfair Display", serif;
        }

        .a4-menu h1 {
            margin: .2em 0 .4em 0;
            font-size: 28px;
            letter-spacing: .8px;
            text-align: center;
        }

        .a4-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8mm;
        }

        .a4-card {
            border: 1.6px solid var(--line);
            border-radius: 10px;
            padding: 6mm;
            background: rgba(255, 255, 255, .05);
        }

        .a4-title {
            font-weight: 800;
            font-size: 16px;
            margin: 0 0 4mm 0;
        }

        .a4-li {
            display: flex;
            justify-content: space-between;
            margin: 2mm 0;
        }

        .a4-li b {
            font-weight: 800;
        }

        /* 结单按钮：放大到 1.5 倍并固定右下 */
        #checkoutBtn {
            position: fixed;
            right: 14px;
            bottom: 14px;
            z-index: 9999;
            box-shadow: 0 10px 26px rgba(0, 0, 0, .35);
            transform: scale(1.5);
            transform-origin: bottom right;
        }

        /* 统计面板 */
        #statsPanel .row {
            grid-template-columns: 1fr 1fr;
        }

        /* 轻提示 */
        .toast {
            position: fixed;
            left: 50%;
            bottom: 88px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .7);
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 800;
            z-index: 99999;
            display: none;
        }

        .toast.show {
            display: block;
        }
    </style>
</head>
<body>
    <header class="shadow">
        <div class="head container">
            <img class="logo" src="logo.png" alt="LYX" onerror="this.style.display='none'">
            <div class="langs">
                <button data-lang="zh" class="active">中文</button>
                <button data-lang="en">English</button>
                <button data-lang="vi">Tiếng Việt</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 基本信息 -->
        <div class="card">
            <div class="row">
                <div>
                    <label data-i="table_label">桌号</label>
                    <input id="tableNo" type="text" placeholder="01 / 02 / 打包">
                    <div id="tables-quick"><span class="table-chip" data-table="打包">打包</span></div>
                </div>
                <div>
                    <label data-i="type_label">用餐方式</label>
                    <select id="type">
                        <option value="dinein" data-i="dinein" selected>堂食</option>
                        <option value="takeaway" data-i="takeaway">打包</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 分类容器 -->
        <div id="cats"></div>

        <!-- 购物车 -->
        <div class="cart card">
            <h3 data-i="cart">订单 / Cart</h3>
            <table id="cartTable">
                <thead>
                    <tr>
                        <th data-i="item">品项</th>
                        <th data-i="qty">数量</th>
                        <th data-i="price">金额</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" data-i="total">合计 Total</td>
                        <td id="total">RM 0.00</td>
                    </tr>
                </tfoot>
            </table>

            <label style="margin-top:10px" data-i="note_label">备注</label>
            <textarea id="note" placeholder="例如：少甜 / 少冰 / 加辣" data-i-ph="note_ph"></textarea>

            <div class="actions no-print">
                <button class="btn full" id="statsBtn">今日明细统计</button>
            </div>

            <div class="kpis no-print">
                <div class="chip">
                    <div data-i="k1">订单笔数</div>
                    <div id="k_orders" style="font-weight:900;font-size:18px">0</div>
                </div>
                <div class="chip">
                    <div data-i="k2">售出件数</div>
                    <div id="k_items" style="font-weight:900;font-size:18px">0</div>
                </div>
                <div class="chip">
                    <div data-i="k3">销售金额</div>
                    <div id="k_amount" style="font-weight:900;font-size:18px">RM 0.00</div>
                </div>
            </div>
        </div>

        <!-- 统计功能面板 -->
        <div class="card no-print" id="statsPanel" style="display:none; margin-top:12px">
            <h3>统计 · 按日期</h3>
            <div class="row">
                <div>
                    <label>日期</label>
                    <input type="date" id="statDate">
                </div>
                <div>
                    <label>操作</label>
                    <button class="btn full" id="calcBtn">统计并发送 WhatsApp</button>
                </div>
            </div>
            <div id="statResult" style="margin-top:10px"></div>
        </div>

        <!-- 打印小票 -->
        <div class="ticket">
            <h2 id="t_title">龍兴记ᝰ云吞面 · 小票</h2>
            <div id="t_shop"></div><div class="hr"></div>
            <div id="t_info"></div><div class="hr"></div>
            <div id="t_items"></div><div class="hr"></div>
            <div id="t_total"></div>
            <div>谢谢惠顾 · Terima kasih</div>
        </div>

        <!-- 结单按钮（1.5x） -->
        <button id="checkoutBtn" class="btn no-print">结单</button>
    </div>

    <div class="toast" id="toast">已添加备注：加奶</div>

    <script>
        /* ===== ① 国际化 (I18N) 配置 ===== */
        let LANG = 'zh';
        const I18N = {
            table_label: { zh: "桌号", en: "Table", vi: "Bàn" },
            type_label: { zh: "用餐方式", en: "Service Type", vi: "Hình thức" },
            dinein: { zh: "堂食", en: "Dine-in", vi: "Ăn tại chỗ" },
            takeaway: { zh: "打包", en: "Takeaway", vi: "Mang đi" },
            cart: { zh: "订单 / Cart", en: "Cart", vi: "Giỏ hàng" },
            item: { zh: "品项", en: "Item", vi: "Món" },
            qty: { zh: "数量", en: "Qty", vi: "SL" },
            price: { zh: "金额", en: "Amount", vi: "Tiền" },
            total: { zh: "合计 Total", en: "Total", vi: "Tổng" },
            note_label: { zh: "备注", en: "Note", vi: "Ghi chú" },
            note_ph: { zh: "例如：少甜 / 少冰 / 加辣", en: "e.g. less sweet / less ice / spicy", vi: "vd: ít ngọt / ít đá / cay" },
            submit: { zh: "发送到 WhatsApp", en: "Send to WhatsApp", vi: "Gửi qua WhatsApp" },
            print: { zh: "打印小票", en: "Print Ticket", vi: "In hoá đơn" },
            export: { zh: "导出本单 CSV", en: "Export this order CSV", vi: "Xuất CSV (đơn này)" },
            k1: { zh: "订单笔数", en: "Orders", vi: "Số đơn" },
            k2: { zh: "售出件数", en: "Items", vi: "Mặt hàng" },
            k3: { zh: "销售金额", en: "Sales", vi: "Doanh thu" },
            add: { zh: "+1", en: "+1", vi: "+1" },
            minus: { zh: "-1", en: "-1", vi: "-1" },
            expand: { zh: "点击展开/收起", en: "Expand/Collapse", vi: "Mở/Đóng" },
            cat_wonton: { zh: "🍜 云吞面", en: "Wonton Noodles", vi: "Mì hoành thánh" },
            cat_drinks: { zh: "🥤 饮料（冰饮 +RM0.20，罐装水除外）", en: "Drinks", vi: "Đồ uống" },
            cat_roti: { zh: "🍞 Roti", en: "Roti", vi: "Roti" },
            cat_auntie: { zh: "🍲 婶婶档（家常小炒 · 粥粉面饭）", en: "Auntie Stall", vi: "Quầy Cô" },
            cat_gx: { zh: "🥟 广西卷筒粉（古早风味）", en: "Guangxi Rice Rolls", vi: "Bánh cuốn Quảng Tây" },
            cat_juice: { zh: "🍹 果汁", en: "Juice", vi: "Nước ép" }
        };
        function t(k) { return (I18N[k] && I18N[k][LANG]) || k; }
        function applyI18N() {
            document.querySelectorAll('[data-i]').forEach(el => el.textContent = t(el.getAttribute('data-i')));
            document.querySelectorAll('[data-i-ph]').forEach(el => el.placeholder = t(el.getAttribute('data-i-ph')));
        }

        /* ===== ② 菜单数据 (MENU) ===== */
        const MENU = [
            { key: 'cat_wonton', sections: [{ title: '', items: [
                { name: '云吞面（小）', price: 6.50 },
                { name: '云吞面（中）', price: 7.30 },
                { name: '云吞面（大）', price: 8.00 },
                { name: '云吞 干捞（1 set）', price: 5.00 },
                { name: '云吞 汤（1 set）', price: 5.00 },
                { name: '加料：云吞 ×3', price: 1.00 },
            ]}]},
            { key: 'cat_drinks', sections: [{ title: '', items: [
                { name: '咖啡（热）', price: 2.30 },
                { name: '咖啡（冰）', price: 2.50 },
                { name: '咖啡C（热）', price: 2.60 },
                { name: '咖啡C（冰）', price: 2.80 },
                { name: '咖啡O（热）', price: 2.00 },
                { name: '咖啡O（冰）', price: 2.20 },
                { name: '奶茶（热）', price: 2.30 },
                { name: '奶茶（冰）', price: 2.50 },
                { name: '奶茶C（热）', price: 2.60 },
                { name: '奶茶C（冰）', price: 2.80 },
                { name: '奶茶咸C（热）', price: 2.60 },
                { name: '奶茶咸C（冰）', price: 2.80 },
                { name: '奶茶O（热）', price: 2.00 },
                { name: '奶茶O（冰）', price: 2.20 },
                { name: 'Nescafe（热）', price: 2.80 },
                { name: 'Nescafe（冰）', price: 3.00 },
                { name: 'Milo（热）', price: 2.60 },
                { name: 'Milo（冰）', price: 2.80 },
                { name: 'Milo C（热）', price: 2.80 },
                { name: 'Milo C（冰）', price: 3.00 },
                { name: 'Milo O（热）', price: 2.60 },
                { name: 'Milo O（冰）', price: 2.80 },
                { name: 'Neslo（热）', price: 2.80 },
                { name: 'Neslo（冰）', price: 3.00 },
                { name: '鸳鸯（热）', price: 2.80 },
                { name: '鸳鸯（冰）', price: 3.00 },
                { name: 'Nestle（热）', price: 2.80 },
                { name: '钓鱼 “茶包”', price: 1.00 },
                { name: '钓鱼 “茶包”', price: 1.00 },
                { name: '凉茶（热）', price: 1.50 },
                { name: '凉茶（冰）', price: 1.70 },
                { name: '玉米（热）', price: 1.50 },
                { name: '玉米（冰）', price: 1.70 },
                { name: '罐装水', price: 2.50 },
            ]}]},
            { key: 'cat_roti', sections: [{ title: '', items: [
                { name: 'Roti', price: 2.00 },
                { name: 'Roti Butter', price: 2.50 },
                { name: '生熟蛋 “Set”', price: 2.40 }
            ]}]},
            { key: 'cat_juice', sections: [{ title: '', items: [
                { name: '苹果汁', price: 5.00 },
                { name: '橙汁', price: 5.00 },
                { name: '萝卜汁', price: 5.00 },
                { name: '西瓜汁', price: 5.00 },
                { name: '蜜瓜汁', price: 5.00 },
            ]}]},
            { key: 'cat_auntie', sections: [{ title: '', items: [
                { name: '苦瓜米粉', price: 6.00 },
                { name: 'Nasi Lemak（蛋）', price: 3.00 },
                { name: 'Nasi Lemak（鸡）', price: 6.00 },
                { name: '面粉糕', price: 6.00 },
                { name: '红烧饭', price: 6.00 },
                { name: '鱼粥（猪肉）', price: 6.00 },
                { name: '鱼粥（鸡肉）', price: 6.00 },
                { name: '面线', price: 6.00 },
                { name: '卤肉饭', price: 6.00 },
                { name: '果条汤', price: 6.00 },
                { name: '加皮蛋', price: 1.00 },
                { name: '酸笋瓜', price: 1.50 },
                { name: '酸羊角豆', price: 1.50 },
                { name: '酸苦瓜', price: 1.50 },
                { name: '酸豆腐', price: 1.50 },
                { name: '炸鸡翅膀', price: 3.00 },
                { name: '煎鸡蛋', price: 1.00 },
            ]}]},
            { key: 'cat_gx', sections: [{ title: '', items: [
                { name: '素粉 (kosong)', price: 1.00 },
                { name: '蔬菜卷筒粉', price: 2.00 },
                { name: '菜加肉卷筒粉', price: 3.00 },
                { name: '肉卷筒粉', price: 3.00 },
                { name: '全家福卷筒粉', price: 4.00 },
                { name: '春卷', price: 1.00 },
                { name: '芋头米糕', price: 1.00 },
            ]}]},
        ];

        /* ===== ③ 菜单构建 (动态生成DOM) ===== */
        const catsEl = document.getElementById('cats');
        const NAME_TO_CAT = new Map();

        /* helper: group drinks into base with hot/ice */
        function groupDrinks(items) {
            const groups = {};
            items.forEach(it => {
                let m = it.name.match(/^(.*)（(热|冰)）$/);
                if (!m) { return; }
                const base = m[1];
                const kind = m[2];
                groups[base] = groups[base] || { hot: null, ice: null };
                if (kind === '热') { groups[base].hot = { price: it.price }; }
                if (kind === '冰') { groups[base].ice = { price: it.price }; }
            });
            return groups;
        }

        MENU.forEach((cat) => {
            const wrap = document.createElement('div');
            wrap.className = 'cat card';
            wrap.innerHTML = `<div class="cat-h" data-toggle><h3>${t(cat.key)}</h3><div style="opacity:.8">${t('expand')}</div></div><div class="cat-b"><div class="grid"></div></div>`;
            const grid = wrap.querySelector('.grid');

            if (cat.key === 'cat_drinks') {
                
                const all = cat.sections.flatMap(s => s.items);

                // 解析饮料命名：基名 + 变体(C/O/咸C/默认) + 温度(热/冰)
                function parseDrinkName(n) {
                    const m = n.match(/^([\u4e00-\u9fa5A-Za-z ]+?)(?:\s?(C|O|咸C))?（(热|冰)）$/);
                    if (!m) return null;
                    const base = m[1].trim();
                    const variant = m[2] || '默认';
                    const temp = m[3];
                    return { base, variant, temp };
                }

                // groups[base][variant] = {hot, ice}
                const groups = {};
                all.forEach(it => {
                    const p = parseDrinkName(it.name);
                    if (!p) return;
                    groups[p.base] = groups[p.base] || {};
                    groups[p.base][p.variant] = groups[p.base][p.variant] || { hot: null, ice: null };
                    if (p.temp === '热') groups[p.base][p.variant].hot = { price: it.price, full: `${p.base}${p.variant==='默认'?'':' '+p.variant}（热）` };
                    if (p.temp === '冰') groups[p.base][p.variant].ice = { price: it.price, full: `${p.base}${p.variant==='默认'?'':' '+p.variant}（冰）` };
                });

                // 渲染基名（默认收起）→ 变体 → 热/冰
                Object.keys(groups).forEach(base => {
                    const variants = groups[base];
                    const variantKeys = Object.keys(variants).sort((a,b)=>{
                        const order = { '默认':0, 'C':1, 'O':2, '咸C':3 };
                        return (order[a] ?? 9) - (order[b] ?? 9);
                    });
                    const baseId = `base-${base.replace(/\s+/g,'_')}`;
                    const baseCard = document.createElement('div');
                    baseCard.className = 'item';
                    baseCard.innerHTML = `
                      <h4 data-base-toggle="${baseId}" style="cursor:pointer">${base}</h4>
                      <div class="base-body" id="${baseId}" style="display:none; margin-top:8px; gap:10px"></div>
                    `;
                    grid.appendChild(baseCard);
                    const baseBody = baseCard.querySelector('.base-body');

                    variantKeys.forEach(variant => {
                        const node = variants[variant];
                        const title = (variant==='默认') ? base : `${base} ${variant}`;
                        const hot = node.hot, ice = node.ice;
                        const hotId = hot ? `${hot.full}__${hot.price}` : '';
                        const iceId = ice ? `${ice.full}__${ice.price}` : '';
                        if (hot) NAME_TO_CAT.set(hot.full, 'cat_drinks');
                        if (ice) NAME_TO_CAT.set(ice.full, 'cat_drinks');

                        baseBody.insertAdjacentHTML('beforeend', `
                          <div class="card" style="border:1px dashed var(--line); border-radius:12px; padding:10px">
                            <div style="font-weight:800; opacity:.95; margin-bottom:6px">${title}</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                              <div>
                                <div style="font-weight:800;opacity:.9">热</div>
                                <div class="price">RM ${hot ? Number(hot.price).toFixed(2) : '—'}</div>
                                <div class="act">
                                  <button class="btn ghost" ${hot ? `data-sub="${hotId}"` : 'disabled'}>${t('minus')}</button>
                                  <div class="qty" data-qty="${hotId}">0</div>
                                  <button class="btn" ${hot ? `data-add="${hotId}"` : 'disabled'}>${t('add')}</button>
                                </div>
                              </div>
                              <div>
                                <div style="font-weight:800;opacity:.9">冰</div>
                                <div class="price">RM ${ice ? Number(ice.price).toFixed(2) : '—'}</div>
                                <div class="act">
                                  <button class="btn ghost" ${ice ? `data-sub="${iceId}"` : 'disabled'}>${t('minus')}</button>
                                  <div class="qty" data-qty="${iceId}">0</div>
                                  <button class="btn" ${ice ? `data-add="${iceId}"` : 'disabled'}>${t('add')}</button>
                                </div>
                              </div>
                            </div>
                          </div>
                        `);
                    });
                });

                // 非热/冰类（如 罐装水、茶包）保持平铺
                all.forEach(it => {
                    if (/（热）|（冰）/.test(it.name)) return;
                    NAME_TO_CAT.set(it.name, 'cat_drinks');
                    const id = `${it.name}__${it.price}`;
                    grid.insertAdjacentHTML('beforeend', `
                      <div class="item">
                        <h4>${it.name}</h4>
                        <div class="price">RM ${Number(it.price).toFixed(2)}</div>
                        <div class="act">
                          <button class="btn ghost" data-sub='${id}'>${t('minus')}</button>
                          <div class="qty" data-qty='${id}'>0</div>
                          <button class="btn" data-add='${id}'>${t('add')}</button>
                        </div>
                      </div>
                    `);
                });
} else {
                cat.sections.forEach(sec => {
                    sec.items.forEach(it => {
                        NAME_TO_CAT.set(it.name, cat.key);
                        const id = `${it.name}__${it.price}`;
                        const isJuice = (cat.key === 'cat_juice');
                        grid.insertAdjacentHTML('beforeend', `
                            <div class="item">
                                <h4>${it.name}</h4>
                                <div class="price">RM ${Number(it.price).toFixed(2)}</div>
                                ${isJuice ? `<div class="extra"><label><input type="checkbox" data-milk="${id}"> 加奶</label></div>` : ''}
                                <div class="act">
                                    <button class="btn ghost" data-sub='${id}'>${t('minus')}</button>
                                    <div class="qty" data-qty='${id}'>0</div>
                                    <button class="btn" data-add='${id}'>${t('add')}</button>
                                </div>
                            </div>`);
                    });
                });
            }

            catsEl.appendChild(wrap);
        });
        catsEl.addEventListener('click', e => {
            const h = e.target.closest('[data-toggle]');
            if (h) { const b = h.parentElement.querySelector('.cat-b'); b.classList.toggle('open'); }
        });
        
        // 二级折叠：饮料内的“基名”（Milo/奶茶/咖啡…）点击展开/收起（默认收起）
        catsEl.addEventListener('click', (e) => {
            const h = e.target.closest('[data-base-toggle]');
            if (!h) return;
            const id = h.getAttribute('data-base-toggle');
            const body = document.getElementById(id);
            if (!body) return;
            body.style.display = (body.style.display === 'none' || !body.style.display) ? 'block' : 'none';
        });
document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.cat-b').forEach(b => b.classList.remove('open'));
        });

        /* ===== ④ 购物车逻辑 ===== */
        let CART = [];
        function ensureNoteMilk(itemName) {
            const note = document.getElementById('note');
            const tag = `${itemName} 加奶`;
            if (!note.value.includes(tag)) {
                note.value = (note.value ? note.value + ' · ' : '') + tag;
            }
        }
        function addToCart(name, price, delta = 1, isMilk = false) {
            const p = Number(price);
            const displayName = isMilk ? `${name}（加奶）` : name;
            let found = CART.find(x => x.name === displayName && x.price === p);
            if (found) { found.qty += delta; if (found.qty <= 0) CART = CART.filter(x => x !== found); }
            else if (delta > 0) { CART.push({ name: displayName, price: p, qty: 1, cat: NAME_TO_CAT.get(name) || 'unknown' }); }
            renderCart();
            syncAllQty();
        }
        function syncAllQty() {
            document.querySelectorAll('.qty[data-qty]').forEach(q => q.textContent = '0');
            CART.forEach(it => {
                const key = `${it.name.replace('（加奶）', '')}__${it.price}`;
                const el = document.querySelector(`.qty[data-qty='${key}']`);
                if (el) el.textContent = it.qty;
            });
        }
        catsEl.addEventListener('click', e => {
            const ad = e.target.getAttribute('data-add');
            const sb = e.target.getAttribute('data-sub');
            if (ad) {
                const [n, p] = ad.split('__');
                const cat = NAME_TO_CAT.get(n) || 'unknown';
                let milk = false;
                if (cat === 'cat_juice') {
                    const chk = document.querySelector(`[data-milk='${n}__${p}']`);
                    milk = !!(chk && chk.checked);
                    if (milk) { ensureNoteMilk(n); showToast('已添加备注：加奶'); }
                }
                addToCart(n, p, 1, milk);
            }
            if (sb) {
                const [n, p] = sb.split('__');
                addToCart(n, p, -1, false);
            }
        });
        function renderCart() {
            const tb = document.querySelector('#cartTable tbody');
            tb.innerHTML = '';
            let total = 0, items = 0;
            CART.forEach((it) => {
                total += it.qty * it.price;
                items += it.qty;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${it.name}</td><td>${it.qty}</td><td>RM ${(it.qty * it.price).toFixed(2)}</td>`;
                tb.appendChild(tr);
            });
            document.getElementById('total').textContent = 'RM ' + total.toFixed(2);
            document.getElementById('k_items').textContent = items;
            document.getElementById('k_amount').textContent = 'RM ' + total.toFixed(2);
        }

        /* ===== ⑤ 导出与打印 ===== */
        function exportCSV() {
            const rows = [["Item", "Qty", "Unit Price", "Amount"]];
            let total = 0;
            CART.forEach(it => { const amt = it.qty * it.price; total += amt; rows.push([it.name, it.qty, it.price, amt]); });
            rows.push(["Total", "", "", total.toFixed(2)]);
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'order.csv';
            a.click();
        }

        /* 打印小票（换行） */
        function printTicket() {
            const tShop = document.getElementById('t_shop');
            const tInfo = document.getElementById('t_info');
            const tItems = document.getElementById('t_items');
            const tTotal = document.getElementById('t_total');
            const table = (document.getElementById('tableNo').value || '').trim();
            const type = document.getElementById('type').value;
            const sum = CART.reduce((s, it) => s + it.qty * it.price, 0);
            document.getElementById('t_title').textContent = '龍兴记ᝰ云吞面 · 小票';
            const logo = '';
            tShop.innerHTML = `${logo}<b>龍运轩ᝰ美食中心</b>`;
            tInfo.textContent = `桌号: ${table || '-'} · ${type === 'dinein' ? '堂食' : '打包'}`;
            tItems.innerHTML = CART.map(it => `${it.name} ×${it.qty} — RM ${(it.qty * it.price).toFixed(2)}`).join('<br>');
            tTotal.textContent = '合计: RM ' + sum.toFixed(2);
            window.print();
        }

        /* ===== ⑥ KPI 统计 ===== */
        const KEY_ORDERS = 'LYX_ACCUM_ORDERS_SIMPLE';
        const KEY_AMOUNT = 'LYX_ACCUM_AMOUNT_SIMPLE';
        const KEY_ITEMS = 'LYX_ACCUM_ITEMS_SIMPLE';
        function bumpKPI(sum) {
            const orders = Number(localStorage.getItem(KEY_ORDERS) || 0) + 1;
            const amount = Number(localStorage.getItem(KEY_AMOUNT) || 0) + Number(sum || 0);
            const items = CART.reduce((s, it) => s + it.qty, 0) + Number(localStorage.getItem(KEY_ITEMS) || 0);
            localStorage.setItem(KEY_ORDERS, String(orders));
            localStorage.setItem(KEY_AMOUNT, String(amount));
            localStorage.setItem(KEY_ITEMS, String(items));
            document.getElementById('k_orders').textContent = orders;
            document.getElementById('k_amount').textContent = 'RM ' + amount.toFixed(2);
            document.getElementById('k_items').textContent = items;
        }
        function initKPI() {
            const orders = Number(localStorage.getItem(KEY_ORDERS) || 0);
            const amount = Number(localStorage.getItem(KEY_AMOUNT) || 0);
            const items = Number(localStorage.getItem(KEY_ITEMS) || 0);
            document.getElementById('k_orders').textContent = orders;
            document.getElementById('k_amount').textContent = 'RM ' + amount.toFixed(2);
            document.getElementById('k_items').textContent = items;
        }

        /* ===== ⑦ 历史订单 & 日期统计 ===== */
        const KEY_ORDERS_JSON = 'LYX_ORDERS_V1';
        function loadOrders() { try { return JSON.parse(localStorage.getItem(KEY_ORDERS_JSON) || '[]'); } catch { return []; } }
        function saveOrders(list) { localStorage.setItem(KEY_ORDERS_JSON, JSON.stringify(list)); }
        function pushOrderToHistory(payload) { const list = loadOrders(); list.push(payload); saveOrders(list); }

        function calcStatsByDate(yyyy_mm_dd) {
            const list = loadOrders();
            if (!yyyy_mm_dd) return { orders: 0, amount: 0, cat: {} };
            const [Y, M, D] = yyyy_mm_dd.split('-').map(Number);
            const start = new Date(Y, M - 1, D, 0, 0, 0, 0).getTime();
            const end = new Date(Y, M - 1, D, 23, 59, 59, 999).getTime();
            const dayOrders = list.filter(o => o.ts >= start && o.ts <= end);
            let sum = 0;
            const catMap = new Map();
            dayOrders.forEach(o => {
                sum += o.total;
                o.items.forEach(it => {
                    const cat = it.cat || 'unknown';
                    const m = catMap.get(cat) || { amount: 0, orders: 0, items: 0 };
                    m.amount += it.price * it.qty;
                    m.items += it.qty;
                    catMap.set(cat, m);
                });
            });
            dayOrders.forEach(o => {
                const seen = new Set();
                o.items.forEach(it => seen.add(it.cat || 'unknown'));
                seen.forEach(cat => {
                    const m = catMap.get(cat) || { amount: 0, orders: 0, items: 0 };
                    m.orders += 1;
                    catMap.set(cat, m);
                });
            });
            const cat = [...catMap.entries()]
                .sort((a, b) => b[1].amount - a[1].amount)
                .reduce((o, [k, v]) => { o[k] = v; return o; }, {});
            return { orders: dayOrders.length, amount: Number(sum.toFixed(2)), cat };
        }
        function renderStatsAndBuildWA(dateStr, stat) {
            const lines = [];
            lines.push(`【龍运轩ᝰ美食中心】销售统计`);
            lines.push(`日期: ${dateStr}`);
            lines.push(`总计: ${stat.orders} 单 · RM ${stat.amount.toFixed(2)}`);
            lines.push('—— 分类统计 ——');
            const humanCatName = (key) => ({
                cat_wonton: '🍜 云吞面',
                cat_drinks: '🥤 饮料',
                cat_roti: '🍞 Roti',
                cat_auntie: '🍲 婶婶档',
                cat_gx: '🥟 广西卷筒粉',
                cat_juice: '🍹 果汁',
                unknown: '其他'
            }[key] || key);
            const out = [];
            Object.keys(stat.cat).forEach(k => {
                const v = stat.cat[k];
                out.push(`${humanCatName(k)} · ${v.orders} 单 · 件数 ${v.items} · RM ${v.amount.toFixed(2)}`);
            });
            const html = [
                `<div>【龍运轩ᝰ美食中心】销售统计</div>`,
                `<div>日期: ${dateStr}</div>`,
                `<div>总计: ${stat.orders} 单 · RM ${stat.amount.toFixed(2)}</div>`,
                `<div>—— 分类统计 ——</div>`,
                ...out.map(s => `<div>${s}</div>`)
            ];
            document.getElementById('statResult').innerHTML = html.join('');
            const wa = [
                `【龍运轩ᝰ美食中心】销售统计`,
                `日期: ${dateStr}`,
                `总计: ${stat.orders} 单 · RM ${stat.amount.toFixed(2)}`,
                `—— 分类统计 ——`,
                ...out,
                '############',
                '以上为自动统计，供内部参考'
            ].join('\n');
            return wa;
        }

        /* ===== ⑧ WhatsApp 发送（稳定版） ===== */
        function openWA(text) {
            const encodedText = encodeURIComponent(text);
            const waUrl = `https://wa.me/?text=${encodedText}`;
            location.href = waUrl;
        }
        function buildOrderText() {
            const table = (document.getElementById('tableNo').value || '').trim() || '-';
            const type = document.getElementById('type').value === 'dinein' ? '堂食' : '打包';
            const note = (document.getElementById('note').value || '').trim();
            const sum = CART.reduce((s, it) => s + it.qty * it.price, 0);
            const orders = Number(localStorage.getItem(KEY_ORDERS) || 0);
            const amount = Number(localStorage.getItem(KEY_AMOUNT) || 0);
            const lines = [
                `【龍运轩ᝰ美食中心】下单`,
                `桌号: ${table} · ${type}`,
                `—— 明细 ——`,
                ...CART.map(it => `${it.name} ×${it.qty}  RM ${(it.qty * it.price).toFixed(2)}`),
                `合计: RM ${sum.toFixed(2)}${note ? ` · 备注: ${note}` : ''}`,
                '############', '############', '############',
                `总计销售: ${orders} 单 · RM ${amount.toFixed(2)}`,
                `已经分类销售总单和销售RM`,
                '############'
            ];
            return lines.join('\n');
        }
        function submitOrderToWhatsApp() {
            if (!CART.length) { return; }
            const sum = CART.reduce((s, it) => s + it.qty * it.price, 0);
            bumpKPI(sum);
            const orderObj = {
                ts: Date.now(),
                table: (document.getElementById('tableNo').value || '').trim() || '-',
                type: (document.getElementById('type').value === 'dinein' ? '堂食' : '打包'),
                note: (document.getElementById('note').value || '').trim(),
                total: Number(sum.toFixed(2)),
                items: CART.map(it => ({ name: it.name, price: it.price, qty: it.qty, cat: (NAME_TO_CAT.get(it.name.replace('（加奶）', '')) || 'unknown') }))
            };
            pushOrderToHistory(orderObj);
            if (navigator.vibrate) { navigator.vibrate(30); }
            const text = buildOrderText();
            openWA(text);
            CART = [];
            renderCart();
            document.getElementById('note').value = '';
            syncAllQty();
        }

        /* ===== ⑨ 界面交互 & 启动 ===== */
        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 1200);
        }
        (function makeTableChips() {
            const wrap = document.getElementById('tables-quick');
            wrap.addEventListener('click', e => {
                const v = e.target.getAttribute('data-table');
                if (!v) return;
                document.querySelectorAll('.table-chip').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('tableNo').value = v;
            });
        })();
        document.querySelectorAll('.langs button').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.langs button').forEach(x => x.classList.remove('active'));
                b.classList.add('active');
                LANG = b.getAttribute('data-lang');
                document.querySelectorAll('#cats .cat').forEach((wrap, i) => { wrap.querySelector('.cat-h h3').textContent = t(MENU[i].key); });
                document.querySelectorAll('.cat-h div:last-child').forEach(el => el.textContent = t('expand'));
                applyI18N();
            };
        });
        applyI18N();
        document.getElementById('checkoutBtn').onclick = submitOrderToWhatsApp;
        document.getElementById('statsBtn').onclick = () => {
            const p = document.getElementById('statsPanel');
            p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
        };
        document.getElementById('calcBtn').onclick = () => {
            const d = document.getElementById('statDate').value;
            if (!d) { return; }
            const stat = calcStatsByDate(d);
            const text = renderStatsAndBuildWA(d, stat);
            openWA(text);
        };
        renderCart();
        syncAllQty();
        initKPI();
    </script>
</body>
</html>
